# Oye Rickshaw Rating System Backend


# Tech Stack 
Express,MongoDb,TypeScript


## Assumptions

1. Both rider and Driver will have unique phone numbers that will be acting as primary key 
to identify them.
2. At the time of login into the application both rider and driver will be issued a JWT token 
to authorize them.

3. The payload for every JWT token will be the _id of the mongo database
4. There may be high chances that bookings once created will be edited due to change in fair
or change of destination location.

## Approach 

1. Used MongoDb for storing data instead of MySql because  the ACID properties are not required in the scenario.
2. Horizontal Scaling will be more efficient rather tha vertical scaling.
3. Since there are two entities Rider and Driver therefore two collections are created.
4. Both the collections will have  ( 1 to Many ) relationship with bookings, hence separate 
collection for bookings has been created to normalize the database
5. Nesting bookings array inside both the collections was also an option but I didn't 
choose that because there may be frequent chances of updation and deletion in the bookings.

6. Here is the Booking Schema 
[![booking-Schema.png](https://i.postimg.cc/qBtbXQgh/booking-Schema.png)](https://postimg.cc/7bknq33w)

7.Here is  UserSchema 

[![booking-Schema.png](https://i.postimg.cc/qBtbXQgh/booking-Schema.png)](https://postimg.cc/7bknq33w)

8. Here is the Driver Schema

[![Screenshot-from-2020-09-17-03-03-05.png](https://i.postimg.cc/k5bGv0rY/Screenshot-from-2020-09-17-03-03-05.png)](https://postimg.cc/PLddtF51)


9. For every api the first middleware is the express validator that is defined 
with JOi validations in validation directory.

10. The next layer of middleware is the JWT verify middleware which authenticates the 
JWT passed in Headers. Once jwt is verified , userId is attached to the user object.


11. I have created two end points 

  A. To post the rating 
    * This end point is not driver  or Rider specific  rather I have made it dynamic 
    * It will recieve path params as (user or rider ) along with rating as another path param
      and JWt token as authorization token.

      Here is the route structure for the api:

     ### route("/rating/:bearer/:bookingId/:rating") ###
     bearer =['Rider','Driver'] 

     bookingId= The booking id generated by mondoDb at the time of creation

     rating = The value to be updated 

  B. Similary to get the aggregate ratings 

    1. MongoDb Aggregation Pipeline is  used to calculate the average
    2. First match pipeline has been used to match the rider id or driver id 
    3. Then average operator has been used to calculate the average 

    Route Structure:

    route("/rating/:bearer")

 12. The last layer of middleware is the Error middleware which is been called
 from top level middlewares for error handling 




### Prerequisites

   Node.js  version >= 10.22.0
   typescript
   Pm2 for Production
   


### Installing

 npm intsall

### Build 
 npm run build

 ### start Dev
 npm run start-dev

 ### start production 
 npm run start-production


## Author

* **Rishabh Sharma** 